<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản Lý Điểm Số - Score Tracker</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .hide-arrows::-webkit-inner-spin-button, 
        .hide-arrows::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Sticky Left Column Shadow */
        .sticky-col-shadow {
            box-shadow: 4px 0 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (SVG Internal) ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Plus = (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />;
        const Minus = (p) => <Icon {...p} path={<line x1="5" y1="12" x2="19" y2="12"></line>} />;
        const Trash2 = (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} />;
        const History = (p) => <Icon {...p} path={<><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path></>} />;
        const RotateCcw = (p) => <Icon {...p} path={<><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></>} />;
        const TableIcon = (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="12" y1="3" x2="12" y2="21"></line></>} />;
        const X = (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>} />;
        const CopyIcon = (p) => <Icon {...p} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></>} />;
        
        // --- COMPONENTS ---

        // 1. Column Component
        const TrackerColumn = ({ data, tableStep, onUpdate, onDelete, onLog }) => {
            const [inputValue, setInputValue] = useState('');
            const inputRef = useRef(null);

            const handleTransaction = (type) => {
                let amount = inputValue !== '' ? parseInt(inputValue) : tableStep;
                if (isNaN(amount) || amount === 0) return;

                const newTotal = type === 'add' ? data.total + amount : data.total - amount;
                
                const newHistory = [{
                    id: Date.now(),
                    type: type,
                    amount: amount,
                    time: new Date().toLocaleString('vi-VN')
                }, ...data.history];

                onUpdate({ ...data, total: newTotal, history: newHistory });
                setInputValue('');
                inputRef.current.focus();
            };

            const formatNumber = (n) => n.toLocaleString('vi-VN');

            return (
                <div className="min-w-[140px] md:min-w-[160px] bg-white border-r border-gray-100 flex flex-col last:border-r-0 group relative">
                    {/* Row 1: Name */}
                    <div className="h-12 border-b border-gray-100 flex items-center justify-center bg-white relative">
                        <input 
                            type="text" 
                            className="w-full h-full text-center bg-transparent font-semibold text-gray-800 focus:bg-blue-50 focus:outline-none focus:ring-inset focus:ring-2 focus:ring-blue-500 px-1 truncate text-sm"
                            value={data.name}
                            onChange={(e) => onUpdate({...data, name: e.target.value})}
                            placeholder="Tên..."
                        />
                        <button 
                            onClick={onDelete}
                            className="absolute -top-1.5 -right-1.5 bg-red-100 text-red-500 rounded-full p-1 opacity-0 group-hover:opacity-100 transition shadow-sm z-10 md:opacity-0 opacity-100" 
                            title="Xóa cột này"
                        >
                            <X size={10} />
                        </button>
                    </div>

                    {/* Row 2: Input Amount */}
                    <div className="h-12 border-b border-gray-100 p-1.5 flex items-center">
                        <input
                            ref={inputRef}
                            type="number"
                            className="w-full h-full bg-gray-50 border border-gray-200 rounded px-1 text-center text-sm focus:outline-none focus:border-blue-500 focus:bg-white hide-arrows font-mono placeholder-gray-400"
                            placeholder={tableStep}
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') handleTransaction('add');
                            }}
                        />
                    </div>

                    {/* Row 3: Actions */}
                    <div className="h-14 border-b border-gray-100 p-1.5 flex gap-1.5">
                        <button 
                            onClick={() => handleTransaction('add')}
                            className="flex-1 bg-green-50 hover:bg-green-100 text-green-600 border border-green-200 rounded flex items-center justify-center transition active:scale-95 shadow-sm active:bg-green-200"
                        >
                            <Plus size={18} strokeWidth={2.5} />
                        </button>
                        <button 
                            onClick={() => handleTransaction('subtract')}
                            className="flex-1 bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 rounded flex items-center justify-center transition active:scale-95 shadow-sm active:bg-red-200"
                        >
                            <Minus size={18} strokeWidth={2.5} />
                        </button>
                    </div>

                    {/* Row 4: Total */}
                    <div className="h-14 flex flex-col items-center justify-center bg-white relative">
                        <span className={`text-xl font-bold font-mono ${data.total < 0 ? 'text-red-500' : 'text-blue-600'}`}>
                            {formatNumber(data.total)}
                        </span>
                        <div className="flex gap-3 absolute bottom-0.5 right-1 opacity-0 group-hover:opacity-100 transition-opacity md:opacity-0 opacity-100 scale-75 origin-bottom-right">
                            <button onClick={() => onLog(data)} className="text-gray-400 hover:text-blue-500 p-1">
                                <History size={16} />
                            </button>
                            <button 
                                onClick={() => { if(confirm('Reset điểm về 0?')) onUpdate({...data, total: 0, history: []}) }} 
                                className="text-gray-400 hover:text-red-500 p-1"
                            >
                                <RotateCcw size={16} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Table Component
        const TrackerTable = ({ tableData, onUpdateTable, onDeleteTable, onDuplicateTable }) => {
            const [showHistory, setShowHistory] = useState(null);

            const addColumn = () => {
                const newCol = {
                    id: Date.now(),
                    name: `Người ${tableData.columns.length + 1}`,
                    total: 0,
                    history: []
                };
                onUpdateTable({ ...tableData, columns: [...tableData.columns, newCol] });
            };

            const updateColumn = (updatedCol) => {
                const newCols = tableData.columns.map(c => c.id === updatedCol.id ? updatedCol : c);
                onUpdateTable({ ...tableData, columns: newCols });
            };

            const deleteColumn = (colId) => {
                if(!confirm("Xóa cột này?")) return;
                const newCols = tableData.columns.filter(c => c.id !== colId);
                onUpdateTable({ ...tableData, columns: newCols });
            };

            // LOGIC TÍNH TỔNG KIỂU "CHỦ XỊ"
            // Tổng người chơi * -1. 
            // VD: Người chơi -10 => Nhà cái +10. Người chơi +20 => Nhà cái -20.
            const grandTotal = tableData.columns.reduce((sum, col) => sum + col.total, 0) * -1;

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6 animate-fade-in">
                    {/* Table Header (Mobile Optimized) */}
                    <div className="bg-slate-800 text-white p-3">
                        <div className="flex flex-col gap-3">
                            {/* Top Row: Title + Total */}
                            <div className="flex justify-between items-start gap-2">
                                <div className="flex items-center gap-2 flex-1 min-w-0">
                                    <TableIcon size={18} className="text-blue-400 shrink-0" />
                                    <input 
                                        className="bg-transparent font-bold text-lg focus:outline-none focus:border-b border-blue-400 w-full placeholder-gray-500 truncate"
                                        value={tableData.title}
                                        onChange={(e) => onUpdateTable({...tableData, title: e.target.value})}
                                        placeholder="Tên Bảng..."
                                    />
                                </div>
                                <div className="text-right shrink-0">
                                    <div className="text-[10px] text-slate-400 uppercase tracking-wider">Tổng</div>
                                    <div className={`font-mono font-bold text-lg leading-none ${grandTotal >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {grandTotal > 0 ? '+' : ''}{grandTotal.toLocaleString('vi-VN')}
                                    </div>
                                </div>
                            </div>

                            {/* Bottom Row: Settings + Actions */}
                            <div className="flex justify-between items-end">
                                <div className="flex items-center bg-slate-700/50 rounded-lg px-2 py-1 gap-2 border border-slate-600">
                                    <span className="text-[10px] text-gray-300 font-bold uppercase tracking-wide">Điểm chuẩn:</span>
                                    <input 
                                        type="number"
                                        className="w-10 bg-transparent text-center font-bold text-yellow-400 focus:outline-none border-b border-gray-500 focus:border-yellow-400 text-sm"
                                        value={tableData.step}
                                        onChange={(e) => onUpdateTable({...tableData, step: parseInt(e.target.value) || 0})}
                                    />
                                </div>

                                <div className="flex items-center gap-1">
                                    <button 
                                        onClick={onDuplicateTable}
                                        className="text-gray-300 hover:text-green-400 transition p-2 hover:bg-slate-700 rounded-lg active:scale-95"
                                        title="Sao chép"
                                    >
                                        <CopyIcon size={18} />
                                    </button>
                                    <button 
                                        onClick={onDeleteTable}
                                        className="text-gray-300 hover:text-red-400 transition p-2 hover:bg-slate-700 rounded-lg active:scale-95"
                                        title="Xóa bảng"
                                    >
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Table Body - Horizontal Scroll */}
                    <div className="overflow-x-auto overscroll-x-contain pb-1">
                        <div className="flex min-w-full">
                            {/* Sticky Row Headers */}
                            <div className="w-20 min-w-[80px] bg-slate-50 border-r border-gray-200 flex flex-col sticky left-0 z-20 sticky-col-shadow">
                                <div className="h-12 border-b border-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-500 uppercase tracking-tight bg-slate-50">Thành Viên</div>
                                <div className="h-12 border-b border-gray-200 flex flex-col items-center justify-center text-[10px] font-bold text-gray-500 uppercase tracking-tight bg-slate-50 leading-tight">
                                    <span>Nhập</span>
                                    <span className="text-[8px] text-gray-400">(Tùy chọn)</span>
                                </div>
                                <div className="h-14 border-b border-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-500 uppercase tracking-tight bg-slate-50">Thao Tác</div>
                                <div className="h-14 flex items-center justify-center text-[10px] font-bold text-gray-500 uppercase tracking-tight bg-slate-50">Tổng</div>
                            </div>

                            {/* Dynamic Columns */}
                            {tableData.columns.map(col => (
                                <TrackerColumn 
                                    key={col.id} 
                                    data={col}
                                    tableStep={tableData.step}
                                    onUpdate={updateColumn} 
                                    onDelete={() => deleteColumn(col.id)}
                                    onLog={() => setShowHistory(col)}
                                />
                            ))}

                            {/* Add Column Button */}
                            <div className="min-w-[60px] flex items-center justify-center border-l border-dashed border-gray-300 bg-gray-50 hover:bg-gray-100 transition cursor-pointer active:bg-gray-200" onClick={addColumn}>
                                <div className="flex flex-col items-center text-blue-500 gap-1">
                                    <div className="bg-blue-100 p-2 rounded-full">
                                        <Plus size={20} />
                                    </div>
                                    <span className="text-[10px] font-bold">Thêm</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* History Modal */}
                    {showHistory && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-end md:items-center justify-center sm:p-4 backdrop-blur-sm" onClick={() => setShowHistory(null)}>
                            <div className="bg-white w-full md:max-w-md md:rounded-xl rounded-t-xl shadow-2xl overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                    <div className="flex items-center gap-2">
                                        <History size={18} className="text-blue-500"/>
                                        <h3 className="font-bold text-gray-800">Lịch sử: {showHistory.name}</h3>
                                    </div>
                                    <button onClick={() => setShowHistory(null)} className="p-1 bg-gray-200 rounded-full hover:bg-gray-300"><X size={16} /></button>
                                </div>
                                <div className="p-4 max-h-[50vh] overflow-y-auto">
                                    {showHistory.history.length === 0 ? (
                                        <p className="text-center text-gray-400 italic py-4">Chưa có lịch sử thay đổi.</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {showHistory.history.map((log, idx) => (
                                                <div key={idx} className="flex justify-between items-center text-sm border-b border-gray-50 pb-2 last:border-0">
                                                    <span className="text-gray-500 text-xs">{log.time}</span>
                                                    <span className={`font-mono font-bold px-2 py-0.5 rounded ${log.type === 'add' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                        {log.type === 'add' ? '+' : ''}{log.type === 'subtract' ? '-' : ''}{log.amount}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 3. Main App Component
        function App() {
            // Load initial data
            const [tables, setTables] = useState(() => {
                try {
                    const saved = localStorage.getItem('scoreTrackerData'); 
                    if (saved) return JSON.parse(saved);
                } catch(e) {}
                return [{ 
                    id: Date.now(), title: 'Bảng Điểm 1', step: 10,
                    columns: [{ id: 1, name: 'Người A', total: 0, history: [] }] 
                }];
            });

            // Save to LocalStorage
            useEffect(() => {
                localStorage.setItem('scoreTrackerData', JSON.stringify(tables));
            }, [tables]);

            const addTable = () => {
                const newTable = {
                    id: Date.now(), title: `Bảng Mới ${tables.length + 1}`, step: 10,
                    columns: [{ id: Date.now() + 1, name: 'Người 1', total: 0, history: [] }]
                };
                setTables([...tables, newTable]);
            };

            const duplicateTable = (tableId) => {
                const tableToClone = tables.find(t => t.id === tableId);
                if (!tableToClone) return;
                const newTable = {
                    ...tableToClone, id: Date.now(), title: `${tableToClone.title} (Copy)`,
                    columns: tableToClone.columns.map(col => ({
                        ...col, id: Date.now() + Math.random(), history: [...col.history]
                    }))
                };
                setTables([...tables, newTable]);
            };

            const updateTable = (updatedTable) => {
                setTables(tables.map(t => t.id === updatedTable.id ? updatedTable : t));
            };

            const deleteTable = (id) => {
                if (confirm("Xóa vĩnh viễn bảng này?")) {
                    setTables(tables.filter(t => t.id !== id));
                }
            };

            return (
                <div className="min-h-screen pb-24 bg-gray-100">
                    {/* Mobile Header */}
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-600 text-white p-1.5 rounded-lg">
                                <TableIcon size={20} />
                            </div>
                            <h1 className="text-lg font-bold text-gray-800">ScoreTracker</h1>
                        </div>
                        <button 
                            onClick={addTable}
                            className="bg-blue-600 active:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1.5 shadow-sm"
                        >
                            <Plus size={16} /> Mới
                        </button>
                    </header>

                    {/* Content */}
                    <main className="max-w-3xl mx-auto p-3">
                        {tables.length === 0 ? (
                            <div className="text-center py-20 opacity-50 flex flex-col items-center">
                                <TableIcon size={48} className="mb-3 text-gray-300" />
                                <p className="text-gray-500">Chưa có bảng nào</p>
                                <button onClick={addTable} className="mt-4 text-blue-500 font-bold text-sm">Tạo bảng ngay</button>
                            </div>
                        ) : (
                            tables.map(table => (
                                <TrackerTable 
                                    key={table.id} 
                                    tableData={table} 
                                    onUpdateTable={updateTable}
                                    onDeleteTable={() => deleteTable(table.id)}
                                    onDuplicateTable={() => duplicateTable(table.id)}
                                />
                            ))
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
